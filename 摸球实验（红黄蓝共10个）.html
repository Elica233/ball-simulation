<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三色球可能性模拟器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        blue: '#3B82F6',
                        yellow: '#F59E0B',
                        light: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .ball-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), inset 0 2px 4px -1px rgba(255, 255, 255, 0.3);
            }
            .bag-gradient {
                background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .pulse-animation {
                animation: pulse 0.2s ease-in-out;
            }
            @keyframes pulse {
                0% { transform: scale(1); opacity: 0.7; }
                50% { transform: scale(1.1); opacity: 1; }
                100% { transform: scale(1); opacity: 0.7; }
            }
            .speed-btn-active {
                @apply bg-primary text-white;
            }
            .segment-line {
                height: 30px;
                display: flex;
                width: 100%;
            }
            .segment {
                height: 100%;
                border-right: 1px solid rgba(255, 255, 255, 0.5);
                transition: all 0.5s ease-in-out;
                flex: 1;
            }
            .segment:last-child {
                border-right: none;
            }
            .result-row:hover {
                @apply bg-gray-50;
            }
            .ball-icon {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 4px;
                vertical-align: middle;
                box-shadow: inset 0 1px 2px rgba(255,255,255,0.5), 0 1px 2px rgba(0,0,0,0.2);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen font-sans text-dark">
    <div class="container mx-auto px-3 py-4 max-w-6xl">
        <!-- 页面标题 -->
        <header class="text-center mb-4">
            <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold text-primary mb-1">三色球可能性模拟器</h1>
            <p class="text-gray-600 text-sm sm:text-base">探索红球、黄球、蓝球的随机抽取实验</p>
        </header>
        
        <!-- 主要内容区域 -->
        <main class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- 左侧：控制面板和图表 (占1/4宽度) -->
            <div class="lg:col-span-1 space-y-4">
                <!-- 速度控制 -->
                <div id="speed-control" class="bg-white rounded-xl shadow-md p-3 transition-all duration-300">
                    <h2 class="text-base font-semibold mb-2 flex items-center">
                        <i class="fa fa-tachometer text-primary mr-2"></i>模拟速度选择
                    </h2>
                    <div class="flex justify-between gap-2">
                        <button id="speed-medium" class="bg-gray-200 flex-1 py-1.5 px-2 rounded-lg text-sm font-medium transition-all">
                            <i class="fa fa-bicycle mr-1"></i>中速
                        </button>
                        <button id="speed-fast" class="speed-btn-active flex-1 py-1.5 px-2 rounded-lg text-sm font-medium transition-all">
                            <i class="fa fa-rocket mr-1"></i>高速
                        </button>
                        <button id="speed-extreme" class="bg-gray-200 flex-1 py-1.5 px-2 rounded-lg text-sm font-medium transition-all">
                            <i class="fa fa-bolt mr-1"></i>极速
                        </button>
                    </div>
                </div>
                
                <!-- 模拟过程图表 -->
                <div class="bg-white rounded-xl shadow-md p-3 transition-all duration-300">
                    <h2 class="text-base font-semibold mb-2 flex items-center">
                        <i class="fa fa-bar-chart text-primary mr-2"></i>模拟过程统计
                    </h2>
                    <div class="h-48">
                        <canvas id="simulation-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：模拟区域和结果 (占3/4宽度) -->
            <div class="lg:col-span-3 space-y-4">
                <!-- 球数量设置 -->
                <div class="bg-white rounded-xl shadow-md p-4 transition-all duration-300">
                    <h2 class="text-base font-semibold mb-3 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>球数量设置
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label for="red-count-input" class="block text-xs font-medium text-gray-700 mb-1 flex items-center">
                                <span class="w-3 h-3 rounded-full bg-red-500 mr-1"></span>红球数量
                            </label>
                            <input type="number" id="red-count-input" min="1" value="5" 
                                   class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-sm">
                        </div>
                        <div>
                            <label for="yellow-count-input" class="block text-xs font-medium text-gray-700 mb-1 flex items-center">
                                <span class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></span>黄球数量
                            </label>
                            <input type="number" id="yellow-count-input" min="1" value="5" 
                                   class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all text-sm">
                        </div>
                        <div>
                            <label for="blue-count-input" class="block text-xs font-medium text-gray-700 mb-1 flex items-center">
                                <span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>蓝球数量
                            </label>
                            <input type="number" id="blue-count-input" min="1" value="5" 
                                   class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm">
                        </div>
                    </div>
                    <button id="apply-settings" class="mt-3 w-full py-1.5 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg shadow transition-all transform hover:scale-105 text-sm">
                        <i class="fa fa-check mr-1"></i>应用设置
                    </button>
                </div>
                
                <!-- 摸球模拟区域 -->
                <div class="bg-white rounded-xl shadow-md p-4 transition-all duration-300">
                    <div class="flex flex-col md:flex-row items-center justify-around gap-4">
                        <!-- 透明袋子 -->
                        <div class="flex flex-col items-center">
                            <h3 class="text-sm font-medium mb-2">袋子中的球</h3>
                            <div id="bag" class="bag-gradient border border-white/30 rounded-2xl w-40 h-48 flex items-center justify-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-3 bg-gray-300/70 rounded-t-2xl"></div>
                                <div id="balls-container" class="flex flex-wrap justify-center items-center gap-1 p-2">
                                    <!-- 红球、黄球和蓝球将通过JS动态生成 -->
                                </div>
                            </div>
                            <p id="ball-count-display" class="mt-2 text-xs text-gray-600">5个红球、5个黄球、5个蓝球</p>
                        </div>
                        
                        <!-- 摸出的球 -->
                        <div class="flex flex-col items-center">
                            <h3 class="text-sm font-medium mb-2">摸出的球</h3>
                            <div id="drawn-balls" class="bg-gray-100 rounded-2xl w-40 h-48 flex flex-wrap justify-center items-center p-2 relative">
                                <!-- 动态显示当前摸出的球 -->
                                <div id="current-drawn-ball" class="w-12 h-12 rounded-full ball-shadow hidden"></div>
                                <p id="no-drawn-text" class="text-gray-400 text-center text-sm">尚未开始模拟</p>
                            </div>
                            <div class="mt-2 flex justify-center gap-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-red-500 mr-1"></div>
                                    <span id="red-result" class="text-xs">0</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></div>
                                    <span id="yellow-result" class="text-xs">0</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 mr-1"></div>
                                    <span id="blue-result" class="text-xs">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 模拟控制 -->
                <div class="bg-white rounded-xl shadow-md p-4 transition-all duration-300">
                    <h2 class="text-base font-semibold mb-3 flex items-center">
                        <i class="fa fa-cogs text-primary mr-2"></i>模拟控制
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        <button id="start-simulation" class="w-full sm:w-auto px-4 py-2 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg shadow transition-all transform hover:scale-105 text-sm">
                            <i class="fa fa-play mr-1"></i> 开始模拟10000次
                        </button>
                        <button id="stop-simulation" class="w-full sm:w-auto px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg shadow transition-all transform hover:scale-105 text-sm hidden">
                            <i class="fa fa-stop mr-1"></i> 停止模拟
                        </button>
                        <button id="save-result" class="w-full sm:w-auto px-4 py-2 bg-secondary hover:bg-secondary/90 text-white font-medium rounded-lg shadow transition-all transform hover:scale-105 text-sm">
                            <i class="fa fa-save mr-1"></i> 保留实验结果
                        </button>
                        <button id="clear-results" class="w-full sm:w-auto px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg shadow transition-all transform hover:scale-105 text-sm">
                            <i class="fa fa-trash mr-1"></i> 清空所有结果
                        </button>
                    </div>
                    <div id="simulation-status" class="mt-2 text-center text-gray-600 text-sm hidden">
                        正在进行模拟：<span id="current-step">0</span>/10000
                    </div>
                </div>
                
                <!-- 模拟结果表格 -->
                <div id="result-table-container" class="bg-white rounded-xl shadow-md p-4 transition-all duration-300">
                    <h2 class="text-base font-semibold mb-3 flex items-center">
                        <i class="fa fa-table text-primary mr-2"></i>模拟结果对比
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">实验情况</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">球数配置</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">红球次数</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">黄球次数</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">蓝球次数</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider flex-1">分布比例</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- 结果将动态添加到这里 -->
                                <tr class="text-center text-gray-400">
                                    <td colspan="6" class="px-4 py-8">
                                        暂无实验结果，请开始模拟并保存结果
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 页脚 -->
        <footer class="mt-4 text-center text-gray-500 text-xs py-2">
            <p>三色球可能性模拟器 | 用于概率教学与实验</p>
        </footer>
    </div>

    <script>
        // 全局变量
        let simulationChart;
        let isSimulating = false;
        let currentStep = 0;
        const TOTAL_SIMULATIONS = 10000;
        let redCount = 0;
        let yellowCount = 0;
        let blueCount = 0;
        let ballsInBag = [];
        let currentSpeed = 'fast'; // medium, fast, extreme
        let batchSize = 20; // 批量处理大小
        let updateInterval = 30; // 每N步更新一次UI
        
        // 球数量设置（初始值设置为5）
        let redBallCount = 5;
        let yellowBallCount = 5;
        let blueBallCount = 5;
        
        // 实验结果记录
        let experimentResults = [];
        let currentExperimentId = 1;
        
        // DOM 元素
        const ballsContainer = document.getElementById('balls-container');
        const drawnBallsElement = document.getElementById('drawn-balls');
        const currentDrawnBall = document.getElementById('current-drawn-ball');
        const noDrawnText = document.getElementById('no-drawn-text');
        const redResultElement = document.getElementById('red-result');
        const yellowResultElement = document.getElementById('yellow-result');
        const blueResultElement = document.getElementById('blue-result');
        const startSimulationButton = document.getElementById('start-simulation');
        const stopSimulationButton = document.getElementById('stop-simulation');
        const saveResultButton = document.getElementById('save-result');
        const clearResultsButton = document.getElementById('clear-results');
        const speedMediumButton = document.getElementById('speed-medium');
        const speedFastButton = document.getElementById('speed-fast');
        const speedExtremeButton = document.getElementById('speed-extreme');
        const simulationStatus = document.getElementById('simulation-status');
        const currentStepElement = document.getElementById('current-step');
        const resultTableContainer = document.getElementById('result-table-container');
        const resultsTableBody = document.getElementById('results-table-body');
        
        // 球数量设置元素
        const redCountInput = document.getElementById('red-count-input');
        const yellowCountInput = document.getElementById('yellow-count-input');
        const blueCountInput = document.getElementById('blue-count-input');
        const applySettingsButton = document.getElementById('apply-settings');
        const ballCountDisplay = document.getElementById('ball-count-display');
        
        // 设置速度级别
        function setSpeedLevel(speed) {
            currentSpeed = speed;
            
            // 更新按钮样式
            speedMediumButton.classList.remove('speed-btn-active');
            speedFastButton.classList.remove('speed-btn-active');
            speedExtremeButton.classList.remove('speed-btn-active');
            
            speedMediumButton.classList.add('bg-gray-200');
            speedFastButton.classList.add('bg-gray-200');
            speedExtremeButton.classList.add('bg-gray-200');
            
            if (speed === 'medium') {
                speedMediumButton.classList.add('speed-btn-active');
                speedMediumButton.classList.remove('bg-gray-200');
                batchSize = 5;
                updateInterval = 10;
            } else if (speed === 'fast') {
                speedFastButton.classList.add('speed-btn-active');
                speedFastButton.classList.remove('bg-gray-200');
                batchSize = 20;
                updateInterval = 30;
            } else if (speed === 'extreme') {
                speedExtremeButton.classList.add('speed-btn-active');
                speedExtremeButton.classList.remove('bg-gray-200');
                batchSize = 50;
                updateInterval = 50;
            }
        }
        
        // 应用球数量设置
        function applyBallSettings() {
            const newRedCount = parseInt(redCountInput.value) || 5;
            const newYellowCount = parseInt(yellowCountInput.value) || 5;
            const newBlueCount = parseInt(blueCountInput.value) || 5;
            
            redBallCount = Math.max(1, newRedCount);
            yellowBallCount = Math.max(1, newYellowCount);
            blueBallCount = Math.max(1, newBlueCount);
            
            // 更新显示
            ballCountDisplay.textContent = `${redBallCount}个红球、${yellowBallCount}个黄球、${blueBallCount}个蓝球`;
            
            // 重新初始化球
            initializeBalls();
            
            // 重置当前模拟状态
            resetCurrentSimulation();
        }
        
        // 初始化球
        function initializeBalls() {
            ballsContainer.innerHTML = '';
            ballsInBag = [];
            
            // 创建红球
            for (let i = 0; i < redBallCount; i++) {
                const ball = createBall('red');
                ballsContainer.appendChild(ball);
                ballsInBag.push({ element: ball, color: 'red', inBag: true });
            }
            
            // 创建黄球
            for (let i = 0; i < yellowBallCount; i++) {
                const ball = createBall('yellow');
                ballsContainer.appendChild(ball);
                ballsInBag.push({ element: ball, color: 'yellow', inBag: true });
            }
            
            // 创建蓝球
            for (let i = 0; i < blueBallCount; i++) {
                const ball = createBall('blue');
                ballsContainer.appendChild(ball);
                ballsInBag.push({ element: ball, color: 'blue', inBag: true });
            }
            
            shuffleBalls();
        }
        
        // 创建球元素
        function createBall(color) {
            const ball = document.createElement('div');
            ball.className = `w-6 h-6 rounded-full ball-shadow transition-all duration-30`;
            
            if (color === 'red') {
                ball.style.backgroundColor = '#EF4444';
            } else if (color === 'yellow') {
                ball.style.backgroundColor = '#F59E0B';
            } else if (color === 'blue') {
                ball.style.backgroundColor = '#3B82F6';
            }
            
            return ball;
        }
        
        // 随机排列球
        function shuffleBalls() {
            for (let i = ballsInBag.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [ballsInBag[i], ballsInBag[j]] = [ballsInBag[j], ballsInBag[i]];
            }
            
            // 更新DOM顺序
            ballsContainer.innerHTML = '';
            ballsInBag.forEach(ball => {
                if (ball.inBag) {
                    ballsContainer.appendChild(ball.element);
                }
            });
        }
        
        // 初始化图表
        function initializeChart() {
            const ctx = document.getElementById('simulation-chart').getContext('2d');
            
            simulationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['红球', '黄球', '蓝球'],
                    datasets: [{
                        label: '摸出次数',
                        data: [0, 0, 0],
                        backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6'],
                        borderColor: ['#DC2626', '#D97706', '#2563EB'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                    animation: { duration: 0 },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // 显示当前摸出的球
        function showDrawnBall(color) {
            // 隐藏提示文本
            noDrawnText.classList.add('hidden');
            
            // 设置球的颜色和动画
            if (color === 'red') {
                currentDrawnBall.style.backgroundColor = '#EF4444';
            } else if (color === 'yellow') {
                currentDrawnBall.style.backgroundColor = '#F59E0B';
            } else if (color === 'blue') {
                currentDrawnBall.style.backgroundColor = '#3B82F6';
            }
            
            currentDrawnBall.classList.remove('hidden');
            
            // 只有中速显示完整动画
            if (currentSpeed === 'medium') {
                currentDrawnBall.classList.remove('pulse-animation');
                void currentDrawnBall.offsetWidth;
                currentDrawnBall.classList.add('pulse-animation');
            }
        }
        
        // 创建分段显示条（严格按照球的总数生成分段）
        function createSegmentLine(containerId, redCount, yellowCount, blueCount, totalBalls) {
            const segmentContainer = document.getElementById(containerId);
            segmentContainer.innerHTML = '';
            
            // 严格按照球的总数创建分段
            const segmentCount = totalBalls;
            
            // 创建分段元素
            for (let i = 0; i < segmentCount; i++) {
                const segment = document.createElement('div');
                segment.className = 'segment';
                segmentContainer.appendChild(segment);
            }
            
            // 立即更新颜色
            setTimeout(() => {
                updateSegmentColors(containerId, redCount, yellowCount, blueCount, segmentCount);
            }, 0);
        }
        
        // 更新分段颜色（严格按照比例分配）
        function updateSegmentColors(containerId, redCount, yellowCount, blueCount, segmentCount) {
            const segmentContainer = document.getElementById(containerId);
            const segments = segmentContainer.querySelectorAll('.segment');
            const totalDraws = redCount + yellowCount + blueCount;
            
            if (totalDraws === 0 || segments.length === 0) return;
            
            // 计算每种颜色的理论概率（基于袋子中的球数比例）
            const redProbability = redCount / totalDraws;
            const yellowProbability = yellowCount / totalDraws;
            const blueProbability = blueCount / totalDraws;
            
            // 计算每种颜色应该填充的分段数
            let redSegments = Math.round(redProbability * segmentCount);
            let yellowSegments = Math.round(yellowProbability * segmentCount);
            let blueSegments = Math.round(blueProbability * segmentCount);
            
            // 调整总数，确保等于segmentCount
            let totalAssigned = redSegments + yellowSegments + blueSegments;
            if (totalAssigned !== segmentCount) {
                const diff = segmentCount - totalAssigned;
                if (diff > 0) {
                    // 分配额外的分段给比例最大的颜色
                    if (redProbability >= yellowProbability && redProbability >= blueProbability) {
                        redSegments += diff;
                    } else if (yellowProbability >= redProbability && yellowProbability >= blueProbability) {
                        yellowSegments += diff;
                    } else {
                        blueSegments += diff;
                    }
                } else {
                    // 从比例最小的颜色中减去多余的分段
                    if (redProbability <= yellowProbability && redProbability <= blueProbability) {
                        redSegments = Math.max(0, redSegments + diff);
                    } else if (yellowProbability <= redProbability && yellowProbability <= blueProbability) {
                        yellowSegments = Math.max(0, yellowSegments + diff);
                    } else {
                        blueSegments = Math.max(0, blueSegments + diff);
                    }
                }
            }
            
            // 重置所有分段为灰色
            segments.forEach(segment => {
                segment.style.backgroundColor = '#e5e7eb';
            });
            
            // 填充颜色分段
            let segmentsFilled = 0;
            
            // 填充红色分段
            for (let i = 0; i < redSegments && segmentsFilled < segmentCount; i++) {
                segments[segmentsFilled].style.backgroundColor = '#EF4444';
                segmentsFilled++;
            }
            
            // 填充黄色分段
            for (let i = 0; i < yellowSegments && segmentsFilled < segmentCount; i++) {
                segments[segmentsFilled].style.backgroundColor = '#F59E0B';
                segmentsFilled++;
            }
            
            // 填充蓝色分段
            for (let i = 0; i < blueSegments && segmentsFilled < segmentCount; i++) {
                segments[segmentsFilled].style.backgroundColor = '#3B82F6';
                segmentsFilled++;
            }
        }
        
        // 批量处理模拟步骤
        function processBatchSimulation() {
            if (!isSimulating || currentStep >= TOTAL_SIMULATIONS) {
                endSimulation();
                return;
            }
            
            let lastColor = 'red';
            const stepsToProcess = Math.min(batchSize, TOTAL_SIMULATIONS - currentStep);
            
            // 批量处理
            for (let i = 0; i < stepsToProcess; i++) {
                // 计算总球数和随机选择
                const totalBalls = redBallCount + yellowBallCount + blueBallCount;
                const randomNum = Math.random() * totalBalls;
                
                let color;
                if (randomNum < redBallCount) {
                    color = 'red';
                    redCount++;
                } else if (randomNum < redBallCount + yellowBallCount) {
                    color = 'yellow';
                    yellowCount++;
                } else {
                    color = 'blue';
                    blueCount++;
                }
                
                lastColor = color;
                currentStep++;
            }
            
            // 显示最后一个球的颜色
            showDrawnBall(lastColor);
            
            // 更新UI
            if (currentStep % updateInterval === 0 || currentStep >= TOTAL_SIMULATIONS) {
                redResultElement.textContent = redCount;
                yellowResultElement.textContent = yellowCount;
                blueResultElement.textContent = blueCount;
                currentStepElement.textContent = currentStep;
                
                simulationChart.data.datasets[0].data = [redCount, yellowCount, blueCount];
                simulationChart.update('none');
            }
            
            // 继续下一批
            if (isSimulating && currentStep < TOTAL_SIMULATIONS) {
                if (currentSpeed === 'extreme') {
                    requestAnimationFrame(processBatchSimulation);
                } else {
                    setTimeout(processBatchSimulation, currentSpeed === 'medium' ? 10 : 0);
                }
            }
        }
        
        // 开始模拟
        function startSimulation() {
            // 重置当前模拟状态
            resetCurrentSimulation();
            
            // 更新UI状态
            isSimulating = true;
            startSimulationButton.classList.add('hidden');
            stopSimulationButton.classList.remove('hidden');
            saveResultButton.classList.add('opacity-50', 'cursor-not-allowed');
            saveResultButton.disabled = true;
            simulationStatus.classList.remove('hidden');
            
            currentStepElement.textContent = '0';
            
            // 开始批量模拟
            requestAnimationFrame(processBatchSimulation);
        }
        
        // 结束模拟
        function endSimulation() {
            isSimulating = false;
            
            // 确保最终状态正确显示
            redResultElement.textContent = redCount;
            yellowResultElement.textContent = yellowCount;
            blueResultElement.textContent = blueCount;
            currentStepElement.textContent = currentStep;
            
            simulationChart.data.datasets[0].data = [redCount, yellowCount, blueCount];
            simulationChart.update();
            
            // 更新UI状态
            startSimulationButton.classList.remove('hidden');
            stopSimulationButton.classList.add('hidden');
            saveResultButton.classList.remove('opacity-50', 'cursor-not-allowed');
            saveResultButton.disabled = false;
        }
        
        // 停止模拟
        function stopSimulation() {
            isSimulating = false;
            
            // 确保当前状态正确显示
            redResultElement.textContent = redCount;
            yellowResultElement.textContent = yellowCount;
            blueResultElement.textContent = blueCount;
            currentStepElement.textContent = currentStep;
            
            // 更新UI状态
            startSimulationButton.classList.remove('hidden');
            stopSimulationButton.classList.add('hidden');
            saveResultButton.classList.remove('opacity-50', 'cursor-not-allowed');
            saveResultButton.disabled = false;
        }
        
        // 保存实验结果
        function saveExperimentResult() {
            // 保存当前实验结果
            const total = redCount + yellowCount + blueCount;
            const redPercent = total > 0 ? (redCount / total) * 100 : 0;
            const yellowPercent = total > 0 ? (yellowCount / total) * 100 : 0;
            const bluePercent = total > 0 ? (blueCount / total) * 100 : 0;
            const totalBalls = redBallCount + yellowBallCount + blueBallCount;
            
            const result = {
                id: currentExperimentId++,
                redBalls: redBallCount,
                yellowBalls: yellowBallCount,
                blueBalls: blueBallCount,
                totalBalls: totalBalls,
                redCount: redCount,
                yellowCount: yellowCount,
                blueCount: blueCount,
                redPercent: redPercent,
                yellowPercent: yellowPercent,
                bluePercent: bluePercent
            };
            
            experimentResults.push(result);
            
            // 更新结果表格
            updateResultsTable();
            
            // 显示成功提示
            showNotification('实验结果已成功保存！情况' + (currentExperimentId - 1));
        }
        
        // 显示通知提示
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-secondary text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center';
            notification.innerHTML = `
                <i class="fa fa-check-circle mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // 重置当前模拟状态
        function resetCurrentSimulation() {
            currentStep = 0;
            redCount = 0;
            yellowCount = 0;
            blueCount = 0;
            
            redResultElement.textContent = '0';
            yellowResultElement.textContent = '0';
            blueResultElement.textContent = '0';
            noDrawnText.classList.remove('hidden');
            currentDrawnBall.classList.add('hidden');
            
            // 重置图表
            simulationChart.data.datasets[0].data = [0, 0, 0];
            simulationChart.update('none');
        }
        
        // 更新结果表格
        function updateResultsTable() {
            resultsTableBody.innerHTML = '';
            
            if (experimentResults.length === 0) {
                resultsTableBody.innerHTML = `
                    <tr class="text-center text-gray-400">
                        <td colspan="6" class="px-4 py-8">
                            暂无实验结果，请开始模拟并保存结果
                        </td>
                    </tr>
                `;
                return;
            }
            
            // 添加所有实验结果
            experimentResults.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'result-row transition-colors';
                
                const segmentId = `segments-${result.id}`;
                
                row.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-primary">
                        情况${result.id}
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center">
                                <span class="ball-icon" style="background-color: #EF4444;"></span>
                                <span>${result.redBalls}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="ball-icon" style="background-color: #F59E0B;"></span>
                                <span>${result.yellowBalls}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="ball-icon" style="background-color: #3B82F6;"></span>
                                <span>${result.blueBalls}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${result.redCount}<br>(${result.redPercent.toFixed(1)}%)
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${result.yellowCount}<br>(${result.yellowPercent.toFixed(1)}%)
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${result.blueCount}<br>(${result.bluePercent.toFixed(1)}%)
                    </td>
                    <td class="px-2 py-2 whitespace-nowrap">
                        <div id="${segmentId}" class="segment-line rounded-md overflow-hidden bg-gray-200"></div>
                    </td>
                `;
                
                resultsTableBody.appendChild(row);
                
                // 创建分段显示（严格按照球的总数）
                createSegmentLine(segmentId, result.redCount, result.yellowCount, result.blueCount, result.totalBalls);
            });
        }
        
        // 清空所有结果
        function clearAllResults() {
            experimentResults = [];
            currentExperimentId = 1;
            updateResultsTable();
            resetCurrentSimulation();
            
            // 显示成功提示
            showNotification('所有实验结果已清空！');
        }
        
        // 事件监听
        startSimulationButton.addEventListener('click', startSimulation);
        stopSimulationButton.addEventListener('click', stopSimulation);
        saveResultButton.addEventListener('click', saveExperimentResult);
        applySettingsButton.addEventListener('click', applyBallSettings);
        clearResultsButton.addEventListener('click', clearAllResults);
        
        // 速度选择事件
        speedMediumButton.addEventListener('click', () => setSpeedLevel('medium'));
        speedFastButton.addEventListener('click', () => setSpeedLevel('fast'));
        speedExtremeButton.addEventListener('click', () => setSpeedLevel('extreme'));
        
        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 设置输入框默认值
            redCountInput.value = 5;
            yellowCountInput.value = 5;
            blueCountInput.value = 5;
            
            // 初始化球显示
            initializeBalls();
            
            // 初始化图表
            initializeChart();
            
            // 设置默认速度
            setSpeedLevel('fast');
            
            // 初始化结果表格
            updateResultsTable();
            
            // 确保保存按钮始终可见
            saveResultButton.classList.remove('hidden');
        });
    </script>
</body>
</html>
